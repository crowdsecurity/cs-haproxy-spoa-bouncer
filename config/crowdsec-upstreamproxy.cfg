# /etc/haproxy/crowdsec-upstreamproxy.cfg
# Example SPOE configuration for HAProxy behind an upstream proxy
# 
# Key difference from standard config:
# - Uses req.hdr_ip(x-real-ip) to extract real client IP from proxy header
# - Event is on-frontend-http-request (not on-client-session) to access HTTP headers
#
# Standard config uses: src-ip=src (direct TCP connection IP)
# Proxy config uses: src-ip=req.hdr_ip(x-real-ip) (IP from HTTP header)

[crowdsec]
spoe-agent crowdsec-agent
    messages    crowdsec-ip crowdsec-http

    option      var-prefix      crowdsec
    option      set-on-error    error
    timeout     hello           100ms
    timeout     idle            30s
    timeout     processing      500ms
    use-backend crowdsec-spoa
    log         global

## This message is used to customise the remediation from crowdsec-ip based on the host header
spoe-message crowdsec-http
    args remediation=var(txn.crowdsec.remediation) crowdsec_captcha_cookie=req.cook(crowdsec_captcha_cookie) id=unique-id host=hdr(Host) method=method path=path query=query version=req.ver headers=req.hdrs body=req.body url=url ssl=ssl_fc
    event on-frontend-http-request

## Extract real client IP from X-Real-IP header (set by upstream proxy)
## IMPORTANT: req.hdr_ip() returns IP type (required by SPOE protocol)
##            Using hdr() would return string type and cause "wrong type" error
spoe-message crowdsec-ip
    args id=unique-id src-ip=req.hdr_ip(x-real-ip) src-port=src_port
    event on-frontend-http-request

