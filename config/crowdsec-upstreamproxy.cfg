# /etc/haproxy/crowdsec-upstreamproxy.cfg
# Example SPOE configuration for HAProxy behind an upstream proxy
# 
# Key difference from standard config:
# - Uses req.hdr_ip() to extract real client IP from proxy header
# - Relies on fallback logic in crowdsec-http when crowdsec-ip doesn't fire
#
# Standard config: crowdsec-ip on-client-session, crowdsec-http on-frontend-http-request
# Proxy config: Only crowdsec-http on-frontend-http-request with src-ip from header

[crowdsec]
spoe-agent crowdsec-agent
    messages    crowdsec-http

    option      var-prefix      crowdsec
    option      set-on-error    error
    timeout     hello           100ms
    timeout     idle            30s
    timeout     processing      500ms
    use-backend crowdsec-spoa
    log         global

## This message extracts real IP from X-Real-IP header and includes all args
## IMPORTANT: req.hdr_ip() returns IP type (required by SPOE protocol)
## The SPOA bouncer will check IP remediation when remediation var is not set
spoe-message crowdsec-http
    args remediation=var(txn.crowdsec.remediation) crowdsec_captcha_cookie=req.cook(crowdsec_captcha_cookie) id=unique-id host=hdr(Host) method=method path=path query=query version=req.ver headers=req.hdrs body=req.body url=url ssl=ssl_fc src-ip=req.hdr_ip(x-real-ip) src-port=src_port
    event on-frontend-http-request
