# https://www.haproxy.com/documentation/hapee/latest/onepage/#home
# HAProxy configuration example for deployment behind upstream proxy
# This config extracts real client IP from X-Real-IP header (set by nginx, Cloudflare, etc.)

global
    log stdout format raw local0
    lua-prepend-path /usr/lib/crowdsec-haproxy-spoa-bouncer/lua/?.lua
    lua-load /usr/lib/crowdsec-haproxy-spoa-bouncer/lua/crowdsec.lua
    setenv CROWDSEC_BAN_TEMPLATE_PATH /var/lib/crowdsec-haproxy-spoa-bouncer/html/ban.html
    setenv CROWDSEC_CAPTCHA_TEMPLATE_PATH /var/lib/crowdsec-haproxy-spoa-bouncer/html/captcha.html

defaults
    log global
    option httplog
    option http-buffer-request
    timeout client 1m
	timeout server 1m
	timeout connect 10s
	timeout http-keep-alive 2m
	timeout queue 15s
	timeout tunnel 4h  # for websocket

frontend test
    mode http
    bind *:9090
    
    unique-id-format %[uuid()]
    unique-id-header X-Unique-ID
    
    # Extract real client IP from proxy headers (runs before SPOE groups)
    # This allows SPOE groups to use src-ip=src which will have the correct IP
    # Priority: X-Real-IP > CF-Connecting-IP > X-Forwarded-For > direct src
    http-request set-src hdr_ip(X-Real-IP) if { req.hdr(X-Real-IP) -m found }
    http-request set-src hdr_ip(CF-Connecting-IP) if { req.hdr(CF-Connecting-IP) -m found } !{ req.hdr(X-Real-IP) -m found }
    http-request set-src hdr_ip(X-Forwarded-For) if { req.hdr(X-Forwarded-For) -m found } !{ req.hdr(X-Real-IP) -m found } !{ req.hdr(CF-Connecting-IP) -m found }
    
    filter spoe engine crowdsec config /etc/haproxy/crowdsec.cfg
    
    # ACL for body size limit (100000 bytes = ~100KB) - adjust here to change limit globally
    # Note spop protocol has limitations on the size of the message, so altering this value will not ensure the whole
    # body is sent for processing but should be enough to prevent overwhelming the SPOA bouncer.
    acl body_within_limit req.body_size -m int le 100000

    # Debug headers to verify IP extraction
    http-request set-header X-Debug-Direct-IP %[src]

    ## If you dont want to render any content, you can use the following line
    # tcp-request content reject if !{ var(txn.crowdsec.remediation) -m str "allow" }

    ## Drop ban requests before http handler is called
    # tcp-request content reject if { var(txn.crowdsec.remediation) -m str "ban" }

    # Send HTTP group conditionally based on body size
    # HTTP handler will check IP directly (no TCP handler in upstream proxy mode)
    # Try req.body_size - if this doesn't work with http-buffer-request, we may need to remove that option
    # Send group with body when body size <= limit (or no body present)
    http-request send-spoe-group crowdsec crowdsec-http-body if body_within_limit || !{ req.body_size -m found }
    # Send group without body when body size > limit
    http-request send-spoe-group crowdsec crowdsec-http-no-body if !body_within_limit

    ## Set a custom header on the request for upstream services to use
    http-request set-header X-Crowdsec-Remediation %[var(txn.crowdsec.remediation)] if { var(txn.crowdsec.remediation) -m found }
    ## Set a custom header on the request for upstream services to use
    http-request set-header X-Crowdsec-IsoCode %[var(txn.crowdsec.isocode)] if { var(txn.crowdsec.isocode) -m found }

    ## Handle 302 redirect for successful captcha validation (native HAProxy redirect)
    http-request redirect code 302 location %[var(txn.crowdsec.redirect)] if { var(txn.crowdsec.remediation) -m str "allow" } { var(txn.crowdsec.redirect) -m found }
    
    ## Call lua script only for ban and captcha remediations (performance optimization)
    http-request lua.crowdsec_handle if { var(txn.crowdsec.remediation) -m str "captcha" }
    http-request lua.crowdsec_handle if { var(txn.crowdsec.remediation) -m str "ban" }

    ## Handle captcha cookie management via HAProxy (new approach)
    ## Set captcha cookie when SPOA provides captcha_status (pending or valid)
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_status) -m found } { var(txn.crowdsec.captcha_cookie) -m found }
    ## Clear captcha cookie when cookie exists but no captcha_status (Allow decision)
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_cookie) -m found } !{ var(txn.crowdsec.captcha_status) -m found }

    use_backend test_backend

backend test_backend
    mode http
    server s1 whoami:2020
    
backend crowdsec-spoa
    mode tcp
    balance roundrobin
    server s2 spoa:9000
    server s3 spoa:9001
