# https://www.haproxy.com/documentation/hapee/latest/onepage/#home
# HAProxy configuration example using HTTP Template Server instead of Lua
# This demonstrates the experimental HTTP template server feature

global
    log stdout format raw local0

defaults
    log global
    option httplog
    timeout client 1m
    timeout server 1m
    timeout connect 10s
    timeout http-keep-alive 2m
    timeout queue 15s
    timeout tunnel 4h  # for websocket

frontend test
    mode http
    bind *:9090
    
    unique-id-format %[uuid()]
    unique-id-header X-Unique-ID
    filter spoe engine crowdsec config /etc/haproxy/crowdsec.cfg

    ## Define ACLs for remediation types
    acl is_ban var(txn.crowdsec.remediation) -m str "ban"
    acl is_captcha var(txn.crowdsec.remediation) -m str "captcha"
    acl is_allow var(txn.crowdsec.remediation) -m str "allow"

    ## Set headers for HTTP template server
    ## IMPORTANT: Remove any user-provided headers first for security, then set from transaction variables
    ## The server will look up host configuration using the Host header (automatically forwarded by HAProxy)
    ## Only the remediation type needs to be sent - all other data comes from host configuration
    http-request del-header X-Crowdsec-Remediation
    http-request set-header X-Crowdsec-Remediation %[var(txn.crowdsec.remediation)] if { var(txn.crowdsec.remediation) -m found }
    
    ## Set a custom header on the request for upstream services to use
    http-request set-header X-Crowdsec-IsoCode %[var(txn.crowdsec.isocode)] if { var(txn.crowdsec.isocode) -m found }

    ## Handle 302 redirect for successful captcha validation (native HAProxy redirect)
    http-request redirect code 302 location %[var(txn.crowdsec.redirect)] if is_allow { var(txn.crowdsec.redirect) -m found }
    
    ## Route to HTTP template server for ban and captcha remediations
    ## Instead of using Lua, we proxy to the HTTP template server
    ## The server uses a catch-all route, so no path rewriting is needed
    ## Use logical OR (||) to route to backend if ban OR captcha remediation
    use_backend http_template_server if is_ban || is_captcha

    ## Handle captcha cookie management via HAProxy
    ## Set captcha cookie when SPOA provides captcha_status (pending or valid)
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_status) -m found } { var(txn.crowdsec.captcha_cookie) -m found }
    ## Clear captcha cookie when cookie exists but no captcha_status (Allow decision)
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_cookie) -m found } !{ var(txn.crowdsec.captcha_status) -m found }

    ## Default backend for allowed requests
    use_backend test_backend

backend test_backend
    mode http
    server s1 whoami:2020
    
backend crowdsec-spoa
    mode tcp
    balance roundrobin
    server s2 spoa:9000
    server s3 spoa:9001

backend http_template_server
    mode http
    # Proxy to the HTTP template server
    # The server will read X-Crowdsec-Remediation header to determine which template to render
    server template_server spoa:8081

