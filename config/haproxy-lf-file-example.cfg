# HAProxy configuration using lf-file templates (no Lua)
# Uses http-request deny for hard blocks (ban) and return for challenges (captcha)

global
    log stdout format raw local0

defaults
    log global
    option httplog
    timeout client 1m
    timeout server 1m
    timeout connect 10s
    timeout http-keep-alive 2m
    timeout queue 15s
    timeout tunnel 4h

frontend test
    mode http
    bind *:9090

    unique-id-format %[uuid()]
    unique-id-header X-Unique-ID
    filter spoe engine crowdsec config /etc/haproxy/crowdsec.cfg

    http-request set-header X-Crowdsec-Remediation %[var(txn.crowdsec.remediation)] if { var(txn.crowdsec.remediation) -m found }
    http-request set-header X-Crowdsec-IsoCode %[var(txn.crowdsec.isocode)] if { var(txn.crowdsec.isocode) -m found }

    # Redirect after successful captcha
    http-request redirect code 302 location %[var(txn.crowdsec.redirect)] if { var(txn.crowdsec.remediation) -m str "allow" } { var(txn.crowdsec.redirect) -m found }

    # CrowdSec remediation pages via lf-file
    # Hard blocks (ban): Use http-request deny - logs show as denial, reinforces security decision
    http-request deny deny_status 403 content-type "text/html; charset=utf-8" lf-file /etc/haproxy/errors/403-ban.http if { var(txn.crowdsec.remediation) -m str "ban" } !{ var(txn.crowdsec.contact_us_url) -m found }
    http-request deny deny_status 403 content-type "text/html; charset=utf-8" lf-file /etc/haproxy/errors/403-ban-contact.http if { var(txn.crowdsec.remediation) -m str "ban" } { var(txn.crowdsec.contact_us_url) -m found }
    
    # Challenge flow (captcha): Use http-request return - treated as additional auth step
    http-request return status 403 content-type "text/html; charset=utf-8" lf-file /etc/haproxy/errors/403-captcha.http if { var(txn.crowdsec.remediation) -m str "captcha" }

    # Captcha cookie management
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_status) -m found } { var(txn.crowdsec.captcha_cookie) -m found }
    http-after-response set-header Set-Cookie %[var(txn.crowdsec.captcha_cookie)] if { var(txn.crowdsec.captcha_cookie) -m found } !{ var(txn.crowdsec.captcha_status) -m found }

    use_backend test_backend

backend test_backend
    mode http
    server s1 whoami:2020

backend crowdsec-spoa
    mode tcp
    balance roundrobin
    server s2 spoa:9000
    server s3 spoa:9001
