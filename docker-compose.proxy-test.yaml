services:
  spoa:
    image: crowdsecurity/crowdsec-spoa:latest
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - crowdsec
    volumes:
      - sockets:/run/
      - templates:/var/lib/crowdsec-haproxy-spoa-bouncer/html/
      - lua:/usr/lib/crowdsec-haproxy-spoa-bouncer/lua/
      - geodb:/var/lib/crowdsec/data/
      - ./config/crowdsec-spoa-bouncer.yaml.local:/etc/crowdsec/bouncers/crowdsec-spoa-bouncer.yaml.local
    networks:
      crowdsec:
        ipv4_address: 10.5.5.254
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 250M
        

  whoami:
    image: traefik/whoami:latest
    networks:
      - crowdsec
    command:
       - --port=2020

  haproxy:
    image: haproxy:3.2-alpine
    volumes:
      - ./config/haproxy-upstreamproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
      - ./config/crowdsec.cfg:/etc/haproxy/crowdsec.cfg
      - sockets:/run/
      - templates:/var/lib/crowdsec-haproxy-spoa-bouncer/html/
      - lua:/usr/lib/crowdsec-haproxy-spoa-bouncer/lua/
    # HAProxy is now only accessible via nginx (not exposed directly)
    depends_on:
      - crowdsec
      - spoa
      - whoami
    networks:
      - crowdsec

  # Nginx acting as upstream proxy (like Cloudflare)
  nginx:
    image: nginx:alpine
    volumes:
      - ./config/nginx-proxy.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - haproxy
    networks:
      - crowdsec
  
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    environment:
      - BOUNCER_KEY_SPOA=+4iYgItcalc9+0tWrvrj9R6Wded/W1IRwRtNmcWR9Ws
      - DISABLE_ONLINE_API=true
      - CROWDSEC_BYPASS_DB_VOLUME_CHECK=true
    volumes:
      - geodb:/staging/var/lib/crowdsec/data/
    networks:
      - crowdsec

volumes:
  lua:
    driver: local
  sockets:
    driver: local
  templates:
    driver: local
  geodb:
    driver: local

networks:
  crowdsec:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "10.5.5.0/24"

