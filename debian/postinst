#!/bin/sh

systemctl daemon-reload

#shellcheck source=./scripts/_bouncer.sh
. "/usr/lib/$DPKG_MAINTSCRIPT_PACKAGE/_bouncer.sh"
START=1

if [ "$1" = "configure" ]; then
    if need_api_key; then
        if ! set_api_key; then
            START=0
        fi
    fi
fi

systemctl --quiet is-enabled "$SERVICE" || systemctl unmask "$SERVICE" && systemctl enable "$SERVICE"

set_local_lapi_url 'CROWDSEC_LAPI_URL'

if ! getent passwd crowdsec-spoa >/dev/null; then
    adduser crowdsec-spoa --system --group --comment "crowdsec haproxy spoa bouncer"
fi

if [ -d "/etc/haproxy" ]; then
    cp /usr/share/doc/crowdsec-haproxy-spoa-bouncer/examples/crowdsec.cfg /etc/haproxy/crowdsec.cfg
fi

echo ""
echo "=========================================="
echo "CrowdSec HAProxy SPOA Bouncer installed"
echo "=========================================="
echo ""

if [ "$START" -eq 0 ]; then
    echo "âš  No API key was generated. Generate one on your LAPI server with:"
    echo "  cscli bouncers add <bouncer_name>"
    echo "  Then add it to: $CONFIG"
    echo ""
fi

echo "Next steps:"
echo "  1. Configure the bouncer in: $CONFIG"
echo "     - Define SPOA workers with a free listen address"
echo "     - Note: 0.0.0.0 exposes the listener externally; use 127.0.0.1 for local-only access"
echo "  2. Ensure /etc/haproxy/crowdsec.cfg exists (SPOE agent configuration)"
echo "  3. Update your HAProxy configuration (/etc/haproxy/haproxy.cfg):"
echo "     - Load Lua packages and crowdsec.lua (see examples)"
echo "     - Add SPOE filter and crowdsec-spoa backend"
echo "  4. Enable and start the bouncer: systemctl enable --now $SERVICE"
echo "  5. Restart HAProxy to apply changes: systemctl restart haproxy"
echo ""
echo "Documentation: https://docs.crowdsec.net/u/bouncers/haproxy_spoa"
echo "Examples: /usr/share/doc/crowdsec-haproxy-spoa-bouncer/examples/"
